---
title: "Homework 3"
author: "Kaleb J. Frierson"
date: "2024-10-12"
output:
  github_document:
    toc: TRUE
---

# Set-Up

Here I call libraries. This is updated throughout completion of the homework such that there is not multiple spots in the project where libraries are called.
```{r calling libraries, message=FALSE}
library(tidyverse)
library(p8105.datasets)
library(patchwork)

```


# Problem 1

Below I bring in the ny_noaa data from the p8105.datasets package as instructed.
```{r noaa data}
data("ny_noaa")

```

## Data Description

Here I determine some basic structurual information using `nrow`, `ncol`, and `colnames` functions to see row count, column count, and variables names, respectively.
```{r structure}
nrow(ny_noaa)
ncol(ny_noaa)
colnames(ny_noaa)
ny_noaa
```

**There are `r nrow(ny_noaa)` rows and `r ncol(ny_noaa)` columns in this dataset. Each row appears to be a different data collection point on a given "date" from a location with a unique "id". Measurements from these locations and times (measured as date) include data for variables called: prcp, snow, snwd, tmax, and tmin. I also view the first ten entries by running the dataset name. Of note, tmin and tmax are being treated as character variables when they should be numeric.** 

Below I treat temperature as numeric. 
```{r temp to number}
hw_df =
  ny_noaa |> 
  mutate(
    tmax = as.numeric(na_if(na_if(tmax, ""), "NA")),  
    tmin = as.numeric(na_if(na_if(tmin, ""), "NA"))  
  )
```

Below I summarize the mean, min, and max of the maximum and minimum temperatures. `na.rm = TRUE` removes missing values from calculations.
```{r mean min max}
hw_df |> 
  summarize(
    tmax_mean = mean(tmax, na.rm = TRUE),
    tmax_min = min(tmax, na.rm = TRUE),
    tmax_max = max(tmax, na.rm = TRUE),
    tmin_mean = mean(tmin, na.rm = TRUE),
    tmin_min = min(tmin, na.rm = TRUE),
    tmin_max = max(tmin, na.rm = TRUE)
  )
```
**Something seems odd here with the values of tmin and max. Temperatures of such extremes (high and low) seem a bit implausible. Especially in NY. Clerical error? Lets look.**

Below I make a `geom_boxplot` to view the spread of the datapoints and find any outliers.
```{r checking outliers}
hw_df |> 
  ggplot(aes(y=tmax)) +
  geom_boxplot()
```
**Strange, extremes don't seem to be outliers. I also find it hard to believe the average maximum temperature is over 100 degrees (Fahrenheit or Celsius). Looking at data description, temperature values are reported in tenths of degrees celcius, NOT degrees. That is weird, will convert that soon so numbers are more sensible. Lets first look at how many missing values there are.**

Below I will use `summarize()` to view missing across all data collection variables.
```{r summary}
hw_df |> 
  summarize(
    prcp_missing = sum(is.na(prcp)),
    snow_missing = sum(is.na(snow)),
    snwd_missing = sum(is.na(snwd)),
    tmax_missing = sum(is.na(tmax)),
    tmin_missing = sum(is.na(tmin))
  )
```
**There are over 2 million rows in this dataset. More than half of the rows have missing data. I would say this is problematic.**

## Data Cleaning

Below I drop rows with missing values, create separate variables for year, month, and day. I also convert temperature to degrees Celsius. 
```{r mutating}
hw_df = 
  hw_df |> 
  drop_na() |> 
  mutate(
    year = year(date),
    month = month(date),
    day = day(date),
    tmax = tmax/10, 
    tmin = tmin/10
  )

hw_df
```

Below I check to see how the values for tmax and tmin look now: 
```{r checking values}
hw_df |> 
  ggplot(aes(y=tmax))+
  geom_boxplot() 

hw_df|> 
  ggplot(aes(y=tmin))+
  geom_boxplot()
```
**Looks a lot more sensible.**

What are the most common values for snowfall? Answering below using `geom_histogram` generated in `ggplot`:
```{r snowfall common}
hw_df |>
  ggplot(aes(x=snwd))+
  geom_histogram()

```
**The most common value for snowfall is 0mm. If you google average annual days of snowfall in NYS, you will find that it varries across city and at its highest is about 52 day (in Buffalo, thank you Lake Erie). The data has over two decades of data during which period most of the days per year do not have snowfall.**

## Explortatory Analysis

Make a facetted plot showing the average max temperature in January and in July in each station across years. This is done below using `ggplot.` I received additional formating guidance from [r-graph-gallery.com](https://r-graph-gallery.com/223-faceting-with-ggplot2.html#:~:text=Faceting%20with%20facet_wrap()&text=It%20builds%20a%20new%20chart,charts%20on%20several%20rows%2Fcolumns.).
```{r facetted plot}
avg_temp =
  hw_df |>
  filter(month %in% c(1, 7)) |> 
  group_by(id, year, month) |> 
  summarize(avg_tmax = mean(tmax, na.rm = TRUE), .groups = 'drop')

ggplot(avg_temp, aes(x = year, y = avg_tmax, color = factor(month))) +
  geom_line() +
  facet_wrap(
    ~ month, scales = "free_y", 
    labeller = labeller(month = c(`1` = "January", `7` = "July"))) +
  labs(title = "Average Max Temperature in January and July by Station",
       x = "Year",
       y = "Average Max Temperature (°C)",
       color = "Month") +
  theme_minimal()

```

**Average maximum temperature seems to be increasing over time. Average minimum temperature doesn't have as much of a positive association with year as maximum does. There seems to be an outlier in ~ 1996 and 1982 for average max temp in January and ~ 1988 for average min temp in July.**

Below I use  `patchwork` and `gpplot` to make a two pannel figure. See [P8105 Visualization 2](https://p8105.com/visualization_pt2.html#patchwork). 
```{r two panel figure}
t_max_t_min = 
  hw_df |> 
  ggplot(aes(x = tmax, y = tmin)) +
  geom_hex() +
  labs(title = "tmax vs tmin",
       x = "Max Temperature (°C)",
       y = "Min Temperature (°C)") +
  theme_minimal()

snowflake = 
  hw_df |>
  filter(snow > 0 & snow < 100) |> 
  ggplot(aes(x = snow)) +
  geom_histogram(binwidth = 1, fill = "blue", color = "black") +
  facet_wrap(~ year) +
  labs(title = "Distribution of Snowfall Values (0 < snow < 100)",
       x = "Snowfall (inches)",
       y = "Frequency") +
  theme_minimal()

t_max_t_min + snowflake

```
  
# Problem 2

## Data Wrangling

Below I use `read_csv` to bring in both datasets. I set missing value information and `col types = false` so that the information doesn't auto populate in the rednered github document. Then I merge them. There are `250` observations in both datasets and the new dataset. 

```{r load & merge}
mims = 
  read_csv("data/mims.csv", na = c("NA", "", "."),
           show_col_types = FALSE)

dem = 
  read_csv("data/dem.csv", na = c("NA", "", "."),
           skip = 4,
           show_col_types = FALSE)

merged <- full_join(dem, mims, by = "SEQN")
```

Below I `drop_na()` so there are no rows with missing values and I recode sex and education to character variables. Then I `pivot_longer()` such that each row is no longer unique to 1 SEQN, but rather each row is an entry per SEQN per minute. I `filter()` to exclude entries where age is less than 21. I also `mutate()` such that minute values are numeric, there is a variable for hour of the day, and a variable for average mims unit per hour of the day. 
```{r tidy & organize}
longer = 
  merged |> 
  drop_na() |> 
  filter(age >= 21) |>
  mutate(
    sex = recode(sex, `1` = "Male", `2` = "Female")) |>
  mutate(
    education = recode(education, `1` = "Less Than High School", 
                       `2` = "High School", 
                       `3` = "More Than High School")
  ) |>
  mutate(education = 
           factor(education, levels = c("Less Than High School", 
                                        "High School", 
                                        "More Than High School"))
  ) |> 
  pivot_longer(
    cols = starts_with("min"),
    names_to = "minute",         
    values_to = "mims_unit"
  ) |> 
  mutate(
    minute = as.numeric(gsub("min", "", minute))
  ) |>
  mutate(
    hour = ceiling(minute / 60))|> 
  group_by(SEQN, hour)|> 
  mutate(
    hour = ceiling(minute / 60))|> 
  mutate(
    avg_hourly_mims_unit = mean(mims_unit)) |> 
  group_by(SEQN, hour)     
```

## Tables & Plots

Below I produce a table for the number of men and women in each education category using `knitr`.
```{r}
table=
  longer |> 
  group_by(education, sex) |> 
  summarize(count = n(), .groups = 'drop') |> 
  pivot_wider(
    names_from = sex, 
    values_from = count, 
    values_fill = list(count = 0))


knitr::kable(table, caption = "Count of Men and Women by Education")

```
Below I create a visualization of the age distributions for men and women in each education category.
```{r}
men =
longer |> 
  filter(sex == "Male") |> 
  ggplot(aes(x = age)) +
  geom_histogram(position = "identity", alpha = 0.3, bins = 15) +
  facet_wrap(~ education) +
  labs(x = "Age", 
       y = "Number of Men") +
  theme_minimal()

women =
longer |> 
  filter(sex == "Female") |> 
  ggplot(aes(x = age)) +
  geom_histogram(position = "identity", alpha = 0.3, bins = 15) +
  facet_wrap(~ education) +
  labs(x= "",
       y = "Number of Women") +
  theme_minimal()

combined_plot=
  women / men + 
  plot_layout(guides = "collect") + 
  plot_annotation(title = "Age Distributions by Sex and Education Category")

combined_plot

```

**Among study participants, there are considerably more males with high school education than female with high school education. About the same across sexes for those with less than high school and for those with more than high school (although one might say there are more women than men if you think 85000 is appreciably different from 81000, I do not).**

## Total Activity 

Below I aggregate across minutes to create a total activity variable for each participant. Then I plot these total activities (y-axis) against age (x-axis). I  compare men to women and have separate panels for each education level. I include a smooth to illustrate differences.
```{r}
total_activity =
  longer |> 
  group_by(SEQN, age, sex, education) |> 
  summarize(total_activity = sum(mims_unit, na.rm = TRUE), 
            .groups = "drop")

total_activity |>  
  ggplot(aes(x= age, y= total_activity, color = sex))+
  geom_point()+ 
  geom_smooth(se = FALSE)+
  facet_wrap(~education)+
  labs(x ="Age", y= "Total Daily Activity", title = "Effect of Age on Daily Activity by Education Status")

```
**Across all levels of education, daily activity decreases with age. The slope of the decease is much more noticeable across the life course with those who have less than a high school education compared to other groups. Among those who complete high school, there is a steep reduction from age 40 to 60 with a plateau for the remainder of the life course.**

Accelerometer data allows the inspection activity over the course of the day. Make a three-panel plot that shows the 24-hour activity time courses for each education level and use color to indicate sex. Describe in words any patterns or conclusions you can make based on this graph; including smooth trends may help identify differences.

# Problem 3

Citi Bike is a bike sharing system in New York City; riders can rent pedal-powered or electric bikes from starting stations and return them to another station at their destination. Introduced in 2013, the system is immensely popular and expanded rapidly. Riders who use this system often may become “members” with lower rental rates.

This zip file contains data on rides taken on the NYC Citi Bike system. Files contain 1% of all rides with a total duration less than 4 hours in each of four months. Import, clean, and tidy these data, and describe the resulting dataset.

Produce a reader-friendly table showing the total number of rides in each combination of year and month separating casual riders and Citi Bike members. Comment on these results.

Make a table showing the 5 most popular starting stations for July 2024; include the number of rides originating from these stations.

Make a plot to investigate the effects of day of the week, month, and year on median ride duration. This plot can include one or more panels, but should facilitate comparison across all variables of interest. Comment on your observations from this plot.

There were relatively few electric Citi Bikes in 2020, but many more are available now. For data in 2024, make a figure that shows the impact of month, membership status, and bike type on the distribution of ride duration. Comment on your results.

